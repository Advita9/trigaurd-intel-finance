<!DOCTYPE html>
<html>
<head>
  <title>FinAgent Dashboard</title>
  <link rel="stylesheet" href="dummy_bank/assets/style.css">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 80px; }
    button { padding: 10px 16px; margin-right: 8px; }
    pre { background: #111; color: #0f0; padding: 12px; height: 200px; overflow-y: auto; }
    img { max-width: 100%; border: 1px solid #ccc; }
  </style>
</head>

<body>

<h1>FinAgent Command Center</h1>

<!-- CHAT INPUT -->
<h3>Command</h3>
<textarea id="command" placeholder="e.g. Buy 500 rupees digital gold"></textarea><br><br>

<button onclick="sendCommand()">Send</button>
<button onclick="startExecution()">Execute</button>
<button onclick="startListening()">üé§ Speak</button>



<script>
const API_BASE = "http://127.0.0.1:8001";

async function sendCommand() {
  
  const text = document.getElementById("command").value.trim();

  if (!text) {
    alert("Please enter a command");
    return;
  }

  // Immediately log in UI (optional UX)
  console.log("Sending command:", text);

  try {
    const res = await fetch(`${API_BASE}/intent`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    if (!res.ok) {
      throw new Error("Intent API failed");
    }

    const data = await res.json();
    console.log("Intent extracted:", data);

  } catch (err) {
    console.error(err);
    alert("Failed to send command");
  }
}


async function execute() {
  try {
    const res = await fetch(`${API_BASE}/plan`, { method: "POST" });
    if (!res.ok) throw new Error("Plan failed");

    await fetch(`${API_BASE}/execute`, { method: "POST" });

  } catch (err) {
    console.error(err);
    alert("Execution failed");
  }
}

/* --------------------------
    VOICE ‚Üí TEXT (STT)
    --------------------------- */

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-IN";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    document.getElementById("command").value = text;
    speak(`You said: ${text}`);
    };

    recognition.onerror = (e) => {
    console.error("Speech error:", e);
    };

    function startListening() {
    recognition.start();
    }

/* --------------------------
    AGENT SPEAKS (TTS)
    --------------------------- */
    function speak(text) {
    if (!text) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-IN";
    utter.rate = 1;
    speechSynthesis.speak(utter);
    }
</script>

<hr>

<!-- STATUS -->
<h3>Status</h3>
<div id="status">Idle</div>
<div id="risk"></div>

<hr>

<!-- SCREENSHOT -->
<h3>Paused Screenshot</h3>
<img id="screenshot" />

<hr>

<!-- LOGS -->
<h3>Execution Logs</h3>
<pre id="logs"></pre>

<hr>

<!-- APPROVAL -->
<button onclick="approve()">Approve</button>
<button onclick="reject()">Reject</button>

<script>
async function sendCommand() {
  const text = document.getElementById("command").value;

  await fetch("/intent", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text })
  });

  await fetch("/plan", { method: "POST" });
  alert("Intent + Plan created");
}

async function startExecution() {
  await fetch("/execute", { method: "POST" });
}

async function approve() {
  await fetch("/approve", { method: "POST" });
}

async function reject() {
  await fetch("/reject", { method: "POST" });
}

// async function refreshState() {
//   const res = await fetch("/state");
//   const data = await res.json();

//   document.getElementById("status").innerText =
//     data.paused ? "‚è∏ Paused" : "‚ñ∂ Running";

//   document.getElementById("risk").innerText =
//     data.risk ? "‚ö†Ô∏è " + data.risk : "";

//   document.getElementById("logs").innerText =
//     (data.logs || []).reverse().join("\n");

//   if (data.screenshot) {
//     document.getElementById("screenshot").src =
//       "data:image/png;base64," + data.screenshot;
//   }
// }

let lastNarratedLog = null;

async function refreshState() {
  const res = await fetch("/state");
  const data = await res.json();

  document.getElementById("status").innerText =
    data.paused ? "‚è∏ Paused" : "‚ñ∂ Running";

  document.getElementById("risk").innerText =
    data.risk ? "‚ö†Ô∏è " + data.risk : "";

  const logs = (data.logs || []).reverse();
  document.getElementById("logs").innerText = logs.join("\n");

  // Narrate only NEW meaningful logs
  const latestLog = logs[logs.length - 1];
  if (latestLog && latestLog !== lastNarratedLog) {
    const narration = humanizeLog(latestLog);
    if (narration) enqueueSpeech(narration);
    lastNarratedLog = latestLog;
  }

  if (data.screenshot) {
    document.getElementById("screenshot").src =
      "data:image/png;base64," + data.screenshot;
  }
}


setInterval(refreshState, 1000);
</script>

<script>
    function listenForApproval() {
    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    rec.lang = "en-IN";

    rec.onresult = async (e) => {
        const text = e.results[0][0].transcript.toLowerCase();
        console.log("Approval heard:", text);

        if (text.includes("approve") || text.includes("yes")) {
        speak("Approved. Continuing execution.");
        await fetch("/approve", { method: "POST" });
        }

        if (text.includes("reject") || text.includes("no")) {
        speak("Rejected. Stopping execution.");
        await fetch("/reject", { method: "POST" });
        }
    };

    rec.start();
    }
    </script>

<script>
    function humanizeLog(log) {
    if (!log) return null;

    if (log.includes("Intent extracted")) {
        return "I have understood your request.";
    }

    if (log.includes("Execution started")) {
        return "Starting execution.";
    }

    if (log.includes("navigate")) {
        return "Opening the required page.";
    }

    if (log.includes("click")) {
        return "Clicking the next option.";
    }

    if (log.includes("enter_amount")) {
        return "Entering the amount.";
    }

    if (log.includes("Typed amount")) {
        return "Amount entered successfully.";
    }

    if (log.includes("Paused before executing")) {
        return "This is a sensitive action. I need your approval.";
    }

    if (log.includes("User approved")) {
        return "Approval received. Continuing.";
    }

    if (log.includes("confirm_payment")) {
        return "Confirming the payment.";
    }

    if (log.includes("Transaction completed")) {
        return "Transaction completed successfully.";
    }

    if (log.includes("User rejected")) {
        return "Transaction rejected. Stopping execution.";
    }

    return null; // Ignore noisy logs
    }
    </script>

<script>
function narrateStep(step) {
  if (!step || !step.action) return null;

  switch (step.action) {
    case "navigate":
      return `Opening the ${step.page} page.`;

    case "click":
      if (step.target === "invest_button") return "Selecting investment options.";
      if (step.target === "digital_gold") return "Choosing digital gold.";
      if (step.target === "proceed_button") return "Proceeding to confirmation.";
      return "Clicking the next option.";

    case "enter_amount":
      return `Entering ${step.amount} rupees.`;

    case "pause_for_approval":
      return "This action requires your approval.";

    case "confirm_payment":
      return "Confirming the payment.";

    case "submit_payment":
      return "Submitting the payment.";

    case "wait_for_success":
      return "Waiting for confirmation.";

    case "log_completion":
      return "Transaction completed successfully.";

    default:
      return null;
  }
}
</script>


<script>
    let speechQueue = [];
    let speaking = false;

    function enqueueSpeech(text) {
    if (!text) return;
    speechQueue.push(text);
    if (!speaking) processSpeechQueue();
    }

    function processSpeechQueue() {
    if (speechQueue.length === 0) {
        speaking = false;
        return;
    }

    speaking = true;
    const text = speechQueue.shift();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-IN";
    utter.rate = 0.95;

    utter.onend = () => {
        setTimeout(processSpeechQueue, 500); // small pause between sentences
    };

    speechSynthesis.speak(utter);
    }
    </script>



</body>
</html>
